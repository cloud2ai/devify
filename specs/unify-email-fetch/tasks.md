# 邮件收取架构统一优化 - 实施计划

## 项目概述

统一和优化邮件收取架构，将现有的两种邮件收取方式（IMAP 用户模式和 Haraka 文件模式）整合到统一的调度和处理流程中，消除重复代码，提高代码复用性和维护性。

## 实施阶段

### 阶段 1：EmailTask 模型扩展

#### 1.1 扩展 EmailTask 模型字段
- [ ] 1.1.1 添加 `email_source` 字段（CharField，选择：IMAP_EMAIL_FETCH, HARAKA_EMAIL_FETCH）
- [ ] 1.1.3 添加 `details` 字段（JSONField，记录执行过程）
- [ ] 1.1.4 添加 `timeout_seconds` 字段（IntegerField，默认600秒）
- [ ] 1.1.5 创建数据库迁移文件
- [ ] 1.1.6 更新模型元数据和索引

#### 1.2 实现状态机管理方法
- [ ] 1.2.1 添加 `PENDING` 和 `SKIPPED` 状态到 TaskStatus 枚举
- [ ] 1.2.2 实现 `update_status()` 方法，支持状态转换和日志记录
- [ ] 1.2.3 实现 `add_execution_log()` 方法，记录执行步骤到 details
- [ ] 1.2.4 实现 `is_timeout()` 方法，检查任务是否超时
- [ ] 1.2.5 实现 `mark_completed()` 方法，标记任务完成
- [ ] 1.2.6 实现 `mark_failed()` 方法，标记任务失败

#### 1.3 实现超时检测和清理机制
- [ ] 1.3.1 实现 `cleanup_stale_tasks()` 函数，清理超时和未闭环任务
- [ ] 1.3.2 实现 `startup_cleanup()` 函数，服务启动时清理异常任务
- [ ] 1.3.3 添加任务锁管理函数（`acquire_task_lock`, `release_task_lock`）
- [ ] 1.3.4 实现防重复任务装饰器 `@prevent_duplicate_task`

#### 1.4 添加单元测试
- [ ] 1.4.1 EmailTask 模型字段测试
- [ ] 1.4.2 状态机转换测试
- [ ] 1.4.3 超时检测测试
- [ ] 1.4.4 清理机制测试
- [ ] 1.4.5 任务锁测试

### 阶段 2：创建统一调度器

#### 2.1 创建 schedule_email_fetch 任务
- [ ] 2.1.1 实现 `schedule_email_fetch()` Celery 任务
- [ ] 2.1.2 实现任务锁检查逻辑
- [ ] 2.1.3 实现未闭环状态机检查和清理
- [ ] 2.1.4 实现同时调度 IMAP 和 Haraka 任务
- [ ] 2.1.5 添加任务锁释放机制

#### 2.2 实现任务锁机制
- [ ] 2.2.1 实现 Redis 缓存锁管理
- [ ] 2.2.2 实现锁超时机制（10分钟）
- [ ] 2.2.3 实现锁冲突处理（SKIPPED 状态）
- [ ] 2.2.4 实现服务重启时的锁清理

#### 2.3 实现状态机闭环管理
- [ ] 2.3.1 实现任务状态检测逻辑
- [ ] 2.3.2 实现异常任务自动取消
- [ ] 2.3.3 实现任务完成状态更新
- [ ] 2.3.4 实现错误处理和重试机制

#### 2.4 添加集成测试
- [ ] 2.4.1 调度器端到端测试
- [ ] 2.4.2 任务锁机制测试
- [ ] 2.4.3 状态机管理测试
- [ ] 2.4.4 错误处理测试

### 阶段 3：创建邮件收取任务

#### 3.1 创建 IMAP 邮件收取任务
- [ ] 3.1.1 实现 `imap_email_fetch_task()` 主任务
- [ ] 3.1.2 实现 `fetch_imap_emails_for_user(user_id)` 用户级任务
- [ ] 3.1.3 集成 EmailProcessor 进行邮件处理
- [ ] 3.1.4 实现 EmailTask 统计更新
- [ ] 3.1.5 添加用户配置验证逻辑

#### 3.2 创建 Haraka 邮件收取任务
- [ ] 3.2.1 实现 `haraka_email_fetch_task()` 主任务
- [ ] 3.2.2 集成 EmailProcessor 进行文件邮件处理
- [ ] 3.2.3 实现全局邮件处理和用户自动分配
- [ ] 3.2.4 实现 EmailTask 统计更新
- [ ] 3.2.5 添加 Haraka 邮件目录配置

#### 3.3 实现任务统计更新
- [ ] 3.3.1 实现邮件处理计数更新
- [ ] 3.3.2 实现错误计数更新
- [ ] 3.3.3 实现执行日志记录
- [ ] 3.3.4 实现任务完成状态更新

#### 3.4 添加任务测试
- [ ] 3.4.1 IMAP 任务单元测试
- [ ] 3.4.2 Haraka 任务单元测试
- [ ] 3.4.3 任务统计更新测试
- [ ] 3.4.4 错误处理测试

### 阶段 4：创建工具类和服务

#### 4.1 创建 EmailConfigManager 工具类
- [ ] 4.1.1 实现 `detect_email_source()` 方法
- [ ] 4.1.2 实现 `get_email_config()` 方法
- [ ] 4.1.3 实现 `validate_imap_config()` 方法
- [ ] 4.1.4 实现 `update_fetch_config()` 方法
- [ ] 4.1.5 实现 `update_fetch_time()` 方法

#### 4.2 创建 EmailSaveService 类
- [ ] 4.2.1 实现 `save_email()` 方法
- [ ] 4.2.2 实现 `process_attachments()` 方法
- [ ] 4.2.3 实现 `find_user_by_recipient()` 方法
- [ ] 4.2.4 实现用户邮箱缓存机制
- [ ] 4.2.5 实现错误处理机制

#### 4.3 实现邮件保存逻辑
- [ ] 4.3.1 实现 EmailMessage 记录创建
- [ ] 4.3.2 实现附件文件保存
- [ ] 4.3.3 实现邮件内容解析和存储
- [ ] 4.3.4 实现用户分配逻辑

#### 4.4 实现附件处理逻辑
- [ ] 4.4.1 实现附件文件提取
- [ ] 4.4.2 实现附件存储路径管理
- [ ] 4.4.3 实现附件元数据记录
- [ ] 4.4.4 实现附件清理机制

#### 4.5 添加服务测试
- [ ] 4.5.1 EmailConfigManager 工具类测试
- [ ] 4.5.2 EmailSaveService 测试
- [ ] 4.5.3 邮件保存逻辑测试
- [ ] 4.5.4 附件处理测试

### 阶段 5：创建清理任务

#### 5.1 创建 cleanup_tasks 任务
- [ ] 5.1.1 实现 `cleanup_tasks()` Celery 定期任务
- [ ] 5.1.2 实现超过1天的已完成任务清理
- [ ] 5.1.3 实现失败任务保留逻辑
- [ ] 5.1.4 实现清理统计信息记录

#### 5.2 创建 startup_cleanup 任务
- [ ] 5.2.1 实现 `startup_cleanup()` 启动清理函数
- [ ] 5.2.2 实现服务重启时的任务状态修复
- [ ] 5.2.3 实现锁资源清理
- [ ] 5.2.4 实现清理日志记录

#### 5.3 实现数据清理策略
- [ ] 5.3.1 实现任务记录清理策略
- [ ] 5.3.2 实现附件文件清理策略
- [ ] 5.3.3 实现日志记录清理策略
- [ ] 5.3.4 实现清理配置管理

#### 5.4 添加清理测试
- [ ] 5.4.1 清理任务单元测试
- [ ] 5.4.2 启动清理测试
- [ ] 5.4.3 数据清理策略测试
- [ ] 5.4.4 清理性能测试

### 阶段 6：监控和配置管理

#### 6.1 实现监控功能
- [ ] 6.1.1 实现基于 EmailTask 的监控指标
- [ ] 6.1.2 实现任务执行状态监控
- [ ] 6.1.3 实现错误率监控
- [ ] 6.1.4 实现性能指标监控

#### 6.2 实现配置管理功能
- [ ] 6.2.1 实现邮件源配置检测
- [ ] 6.2.2 实现配置验证机制
- [ ] 6.2.3 实现配置更新接口
- [ ] 6.2.4 实现配置缓存机制

#### 6.3 添加监控测试
- [ ] 6.3.1 监控功能测试
- [ ] 6.3.2 配置管理测试
- [ ] 6.3.3 性能监控测试

### 阶段 7：迁移和清理

#### 7.1 更新现有调用代码
- [ ] 7.1.1 更新现有邮件收取任务调用
- [ ] 7.1.2 更新现有调度器配置
- [ ] 7.1.3 更新现有错误处理逻辑
- [ ] 7.1.4 更新现有监控代码

#### 7.2 移除旧的调度任务
- [ ] 7.2.1 移除旧的 IMAP 调度任务
- [ ] 7.2.2 移除旧的 Haraka 调度任务
- [ ] 7.2.3 移除重复的邮件处理代码
- [ ] 7.2.4 清理无用的导入和依赖

#### 7.3 清理重复代码
- [ ] 7.3.1 识别和移除重复的邮件处理逻辑
- [ ] 7.3.2 统一错误处理机制
- [ ] 7.3.3 统一日志记录格式
- [ ] 7.3.4 优化代码结构

#### 7.4 更新文档
- [ ] 7.4.1 更新 API 文档
- [ ] 7.4.2 更新部署文档
- [ ] 7.4.3 更新监控文档
- [ ] 7.4.4 更新故障排除文档

## 测试策略

### 1. 单元测试
- [ ] EmailTask 模型扩展测试
- [ ] 状态机管理测试
- [ ] 超时检测测试
- [ ] 清理机制测试
- [ ] EmailConfigManager 工具类测试
- [ ] EmailSaveService 测试
- [ ] 监控功能测试

### 2. 集成测试
- [ ] 端到端邮件收取测试
- [ ] 任务状态转换测试
- [ ] 超时处理测试
- [ ] 清理任务测试
- [ ] 错误处理测试

### 3. 性能测试
- [ ] 大量邮件处理测试
- [ ] 并发任务执行测试
- [ ] 内存使用测试
- [ ] 数据库性能测试

## 验收标准

### 功能验收
- [ ] 统一调度器能同时管理 IMAP 和 Haraka 邮件收取
- [ ] EmailTask 模型能完整记录任务执行过程
- [ ] 状态机能正确处理所有任务状态转换
- [ ] 任务锁机制能防止重复执行
- [ ] 清理机制能自动清理过期任务

### 性能验收
- [ ] 邮件处理性能不低于现有系统
- [ ] 任务执行延迟在可接受范围内
- [ ] 内存使用稳定，无内存泄漏
- [ ] 数据库查询性能良好

### 稳定性验收
- [ ] 系统能处理各种异常情况
- [ ] 服务重启后能正确恢复
- [ ] 错误处理机制完善
- [ ] 监控和告警功能正常

## 风险评估

### 高风险
- 数据库迁移可能影响现有数据
- 任务状态机变更可能影响现有任务
- 调度器变更可能影响现有邮件收取

### 中风险
- 新代码可能引入新的 bug
- 性能可能不如预期
- 配置变更可能影响现有功能

### 低风险
- 工具类实现相对简单
- 测试覆盖充分
- 文档完善

## 实施建议

1. **分阶段实施**：按照阶段顺序逐步实施，每个阶段完成后进行测试
2. **充分测试**：每个功能都要有完整的单元测试和集成测试
3. **渐进式迁移**：先实现新功能，再逐步迁移现有功能
4. **监控和回滚**：实施过程中密切监控，准备回滚方案
5. **文档更新**：及时更新相关文档和配置说明