# 需求文档

## 概述

本功能解决 Haraka 邮件处理中的磁盘空间管理问题。核心需求是定期对 Haraka 收到的邮件进行处理，防止时间较长占用磁盘空间。通过优化目录结构和清理策略，确保邮件文件不会无限积累。

## 需求

### 需求 1

**用户故事：** 作为系统管理员，我希望邮件处理完成后直接移动到 processed 目录，并在处理完成后定期删除文件，以便简化目录结构并释放存储空间。

#### 验收标准

1. 当邮件处理完成时，系统应将文件从 processing 目录移动到 processed 目录
2. 当邮件在 processed 目录中超过 10 分钟时，系统应删除邮件文件
3. 当邮件处理失败时，系统应将文件移动到 failed 目录
4. 系统应记录文件移动和删除的详细日志

### 需求 2

**用户故事：** 作为系统管理员，我希望基于邮件接收时间清理 inbox 目录，考虑用户注册和邮件接收的时间差，确保未及时处理的邮件得到适当清理。

#### 验收标准

1. 当邮件在 inbox 目录中超过设定时间（如 1 小时）时，系统应删除邮件文件
2. 清理逻辑应基于邮件的实际接收时间，而不是文件创建时间
3. 当 haraka 轮询处理 inbox 目录中的邮件时，通过比对数据库记录判断：如果数据库记录已存在则更新，如果不存在则创建，防止数据库记录已创建而文件尚未移动的临界状态
4. 系统应记录 inbox 清理的统计信息

### 需求 3

**用户故事：** 作为系统管理员，我希望 failed 目录中的邮件文件能够定期清理，因为这些文件通常是攻击邮件或无法识别的内容，不需要保留在数据库中。

#### 验收标准

1. 当邮件解析失败时，系统应将文件移动到 failed 目录
2. 当邮件在 failed 目录中超过 10 分钟时，系统应删除邮件文件
3. 失败邮件不需要在数据库中创建记录，因为很可能是恶意内容
4. 系统应记录 failed 目录清理的统计信息

### 需求 4

**用户故事：** 作为系统管理员，我希望系统能够定期自动运行清理任务，确保各目录中的过期文件得到及时清理。

#### 验收标准

1. 系统应提供可配置的定期清理任务（如每 5 分钟运行一次）
2. 清理任务应独立于主邮件处理流程运行
3. 当清理任务失败时，不应影响正常的邮件处理
4. 系统应记录清理任务的执行结果和统计信息

### 需求 5

**用户故事：** 作为系统管理员，我希望能够通过命令行工具配置清理参数并监控清理效果，以便根据实际情况调整清理策略。

#### 验收标准

1. 系统应提供 Django 管理命令 `cleanup_email_files` 用于手动执行清理操作
2. 命令应支持 `--show-stats` 参数显示各目录的统计信息（文件数量和大小）
3. 命令应支持 `--dry-run` 参数预览清理操作而不实际删除文件
4. 命令应支持 `--action` 参数指定清理类型（inbox、failed、all）
5. 命令应支持 `--older-than-hours` 和 `--older-than-days` 参数自定义清理时间
6. 系统应提供配置文件设置默认的清理时间间隔
7. 系统应记录详细的清理日志，便于问题排查

### 需求 6

**用户故事：** 作为系统管理员，我希望定期清理 EmailTask 表中的历史记录，防止表记录过多影响性能，同时保留最近几天的记录用于监控。

#### 验收标准

1. 系统应定期清理 EmailTask 表中超过 3 天的历史记录
2. 清理任务应独立运行，不影响正常的邮件处理
3. 系统应记录 EmailTask 清理的统计信息，相关的清理信息也应记录在 EmailTask 中
4. 每次 Haraka 清理操作应创建一条 EmailTask 记录，记录所有目录的清理情况
5. EmailTask 记录应包含总体统计和各目录详细信息（inbox/processed/failed）
6. 每次 EmailTask 清理操作应创建独立的 EmailTask 记录
